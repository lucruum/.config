#!/usr/bin/env bash

can-run() {
    type -fp "$1" > /dev/null
}

fatal() {
    for it; do
        echo -e "$it" >&2
    done
    exit 1
}

getopt() {
    local stderr=$(command getopt "$@" 2>&1 > /dev/null)
    echo "$stderr" |
    while IFS= read -r; do
        [[ $REPLY =~ ^getopt:\ option\ \'(.*)\'\ is\ ambiguous ]] && echo "Option is ambiguous: $(quote "${BASH_REMATCH[1]}")" >&2
        [[ $REPLY =~ ^getopt:\ unrecognized\ option\ \'(.*)\'$ ]] && echo "Invalid option: $(quote "${BASH_REMATCH[1]}")" >&2
        [[ $REPLY =~ ^getopt:\ option\ \'(.*)\'\ doesn\'t\ allow\ an\ argument$ ]] && echo "Option does not allow an argument: $(quote "${BASH_REMATCH[1]}")" >&2
        [[ $REPLY =~ ^getopt:\ option\ \'(.*)\'\ requires\ an\ argument$ ]] && echo "Option requires an argument: $(quote "${BASH_REMATCH[1]}")" >&2
        [[ $REPLY =~ ^getopt:\ invalid\ option\ --\ \'(.)\'$ ]] && echo "Invalid option: -${BASH_REMATCH[1]}" >&2
    done
    [[ -n $stderr ]] && return 1
    command getopt "$@"
}

quote() {
    if [[ -z $1 ]]; then
        echo -n "''"
    elif [[ $1 =~ [^+,\-./:=@_^[:alnum:]] ]]; then
        echo -n "'"
        echo -n "$1" | sed -E 's/(['"'"'!])/'"'"'\\\1'"'"'/g'
        echo -n "'"
    else
        echo -n "$1"
    fi
}

usage() {
    cat <<'EOI'
A lightweight wrapper for `docker run` that ensures all build requirements are
installed, mounts the working arc repository, and runs a container in the proper
environment

Usage:
    bmc-docker-run [-h] MACHINE

Options:
    -h, --help
        Print a brief help message

Environment:
    ARCADIA
        In case the script runs outside of an arc repository, the value of
        `ARCADIA` will be used to determine the repository location
EOI
exit 0
}

ARGV=$(getopt -o h -l help -- "$@")
(( !$? )) || fatal
eval set -- "$ARGV"

while true; do
    case $1 in
        -h|--help)
            usage;;
        --)
            shift
            break;;
    esac
done

(( $# )) || fatal "Missing operand: MACHINE"
machine=$1; shift
[[ $machine =~ ^(cherokee|g2|navajo)$ ]] ||
fatal "Invalid machine value: $(quote "$machine")"

(( !$# )) || fatal "Extra operand: $(quote "$1")"

can-run "docker" || fatal "Command not found: docker"
docker ps > /dev/null ||
fatal "Non-root access to Docker is not granted." \
      "See https://docs.docker.com/engine/install/linux-postinstall for details"
docker run -it --rm busybox sh -c 'ping -c1 -w1 ya.ru > /dev/null' 2> /dev/null ||
fatal "Docker in QYP cannot send requests to the external network by default." \
      "See https://docs.yandex-team.ru/qyp/docker-network for details"

can-run "arc" ||
fatal "Command not found: arc." \
      "See https://docs.yandex-team.ru/devtools/intro/quick-start-guide#arc-setup for details"

root=$(arc root 2> /dev/null)
if (( $? )); then
    [[ -n $ARCADIA ]] || fatal "Not a mounted arc repository. Did you forget to mount arcadia?"
    [[ -e $ARCADIA ]] || fatal "No such file or directory: $(quote "$ARCADIA") (from \$ARCADIA)"
    [[ -d $ARCADIA ]] || fatal "Not a directory: $(quote "$ARCADIA") (from \$ARCADIA)"
    root=$ARCADIA
fi
path=$root/hwrnd/openbmc_layer
can-run "jq" ||
can-run "ya" && jq() { ya tool jq "$@"; } ||
fatal "Command not found: jq"
findmnt -JT "$path" |
jq -r \
   --arg root "$root" \
   '.filesystems[] |
   select(.source == "arc" and .target == $root) |
   .options' |
grep -qw -e "allow_other" -e "allow_root" ||
fatal "Directory $(quote "$path") is inaccessible from within a Docker container" \
      "because it is mounted under $(quote "$root")," \
      "which lacks the necessary permissions for other users to access files via FUSE." \
      "Consider remounting $(quote "$root") using the following commands:" \
      "    \$ arc unmount $(quote "$root") && arc mount --allow-other $(quote "$root")"

can-run "git" || fatal "Command not found: git"
( cd "$path"
upstream=$(cat upstream_hash)
git rev-parse --is-inside-work-tree &> /dev/null || git init
git remote | grep -qx "origin" || git remote add origin "https://github.com/openbmc/openbmc.git"
[[ $(git rev-parse -q --verify FETCH_HEAD) == $upstream ]] || git fetch --depth=1 origin $upstream
git reset --hard FETCH_HEAD
rm ".eslintrc.json"
rm ".gitignore"
rm ".gitreview"
rm -rd ".github/" )

can-run "yav" ||
fatal "Command not found: yav." \
      "See https://docs.yandex-team.ru/yav-api/cli/install for details"
[[ -n $YAV_TOKEN ]] || export YAV_TOKEN=$(yav oauth)
[[ -n $YAV_TOKEN ]] ||
fatal "Unable to determine YAV token." \
      "Please set the YAV_TOKEN environment variable"

docker run -it \
           --name=$machine \
           --rm `
           # arc внутри контейнера, не разделяющего сеть с хостом,
           # сыпет ошибками "Error occured while calling helper-daemon"
           # при включённой телеметрии` \
           -e ARC_DISABLE_TELEMETRY=1 \
           -v "$(which arc):/usr/bin/arc" \
           -v "$root:$root" `
           # Папка $root/.arc является символической ссылкой на $HOME/.arc` \
           -v "$HOME/.arc:$HOME/.arc" \
           \
           -e BB_ENV_PASSTHROUGH_ADDITIONS=YAV_TOKEN \
           -e YAV_TOKEN=$YAV_TOKEN \
           -v "$(which yav):/usr/bin/yav" \
           \
           crops/poky:ubuntu-22.04 \
           --workdir="$path" \
           sh -c '. ./setup '$machine'; HOME=$(pwd) bash'
