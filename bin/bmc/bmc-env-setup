#!/usr/bin/env bash

__DIR__=$(dirname -- "$0")
. "$__DIR__"/can-run.sh
. "$__DIR__"/fatal.sh
. "$__DIR__"/getopt.sh
. "$__DIR__"/quote.sh

usage() {
    cat <<'EOI'
A lightweight wrapper for `docker run` that ensures all build requirements are
installed, mounts the working arc repository, and runs a container in the proper
environment

Usage:
    bmc-env-setup [-h] MACHINE [BUILD]

Arguments:
    MACHINE
        Fifth generation target hardware. The possible values are "cherokee",
        "g2" and "navajo"

    BUILD
        Explicitly specify a build directory. If no directory is provided,
        "{OEROOT}/build" will be used by default, where `OEROOT` is the
        directory from which the top-level `oe-init-build-env` script is sourced

Options:
    -h, --help
        Print a brief help message

    -n, --name=NAME
        Assign a name to the container

Environment:
    ARCADIA
        In case the script runs outside of an arc repository, the value of
        `ARCADIA` will be used to determine the repository location

    YAV_TOKEN
        The OAuth token utilized for authorization in YAV. If not provided, the
        default value will be sourced from `$(yav oauth)`
EOI
exit 0
}

ARGV=$(getopt -o hn: -l help,name: -- "$@")
(( !$? )) || fatal
eval set -- "$ARGV"

while true; do
    case $1 in
        -h|--help)
            usage;;
        -n|--name)
            name=$2
            shift 2;;
        --)
            shift
            break;;
    esac
done

(( $# )) || fatal "Missing operand: MACHINE"
machine=$1; shift
[[ $machine =~ ^(cherokee|g2|navajo)$ ]] ||
fatal "Invalid machine value: $(quote "$machine")"

[[ -n $name ]] || name=$machine
[[ $name =~ ^[a-zA-Z0-9][a-zA-Z0-9_.-]*$ ]] ||
fatal "Invalid name value: $(quote "$name")"

if (( $# )); then
    build=$1; shift
    [[ -e $build ]] || mkdir -p "$build"
    [[ -d $build ]] || fatal "Not a directory: $(quote "$build")"
    build=$(realpath -m "$build")
fi

(( !$# )) || fatal "Extra operand: $(quote "$1")"

can-run "docker" || fatal "Command not found: docker"
docker ps > /dev/null ||
fatal "Non-root access to Docker is not granted." \
      "See https://docs.docker.com/engine/install/linux-postinstall for details"
docker run -it --rm busybox sh -c 'ping -c1 -w1 ya.ru > /dev/null' 2> /dev/null ||
fatal "Docker in QYP cannot send requests to the external network by default." \
      "See https://docs.yandex-team.ru/qyp/docker-network for details"

can-run "arc" ||
fatal "Command not found: arc." \
      "See https://docs.yandex-team.ru/devtools/intro/quick-start-guide#arc-setup for details"

arcadia=$(arc root 2> /dev/null)
if (( $? )); then
    [[ -n $ARCADIA ]] || fatal "Not a mounted arc repository. Did you forget to mount arcadia?"
    [[ -e $ARCADIA ]] || fatal "No such file or directory: $(quote "$ARCADIA") (from \$ARCADIA)"
    [[ -d $ARCADIA ]] || fatal "Not a directory: $(quote "$ARCADIA") (from \$ARCADIA)"
    arcadia=$ARCADIA
fi

root=$arcadia/hwrnd/openbmc_layer

[[ -n $build ]] || build=$root/build
if [[ $build =~ $arcadia/* ]]; then
    can-run "ya" && jq() { ya tool jq "$@"; } ||
    fatal "Command not found: jq"
    findmnt -JT "$root" |
    jq -r \
       --arg arcadia "$arcadia" \
       '.filesystems[] |
       select(.source == "arc" and .target == $arcadia) |
       .options' |
    grep -qw -e "allow_other" -e "allow_root" ||
    fatal "Directory $(quote "$build") is inaccessible from within a Docker container" \
          "because it is mounted under $(quote "$arcadia")," \
          "which lacks the necessary permissions for other users to access files via FUSE." \
          "Consider remounting $(quote "$arcadia") using the following commands:" \
          "    \$ arc unmount $(quote "$arcadia") && arc mount --allow-other $(quote "$arcadia")"
fi

docker ps --format=json |
jq -r '.Names' |
grep -qx "$name" &&
fatal "The container name \`$name\` is already in use" \
      "Provide a unique container name using the \`--name\` option"

can-run "yav" ||
fatal "Command not found: yav." \
      "See https://docs.yandex-team.ru/yav-api/cli/install for details"

[[ -n $YAV_TOKEN ]] || export YAV_TOKEN=$(yav oauth)
[[ -n $YAV_TOKEN ]] ||
fatal "Unable to determine YAV token." \
      "Please set the YAV_TOKEN environment variable"
yav list secrets &> /dev/null ||
fatal "Invalid OAuth token" \
      "See https://docs.yandex-team.ru/blackbox/methods/oauth#status for details"

can-run "git" || fatal "Command not found: git"
( cd "$root"
upstream=$(cat upstream_hash)
git rev-parse --is-inside-work-tree &> /dev/null || git init
git remote | grep -qx "origin" || git remote add origin "https://github.com/openbmc/openbmc.git"
[[ $(git rev-parse -q --verify FETCH_HEAD) == $upstream ]] || git fetch --depth=1 origin $upstream
git reset --hard FETCH_HEAD
rm ".eslintrc.json"
rm ".gitignore"
rm ".gitreview"
rm -rd ".github/" )

if [[ $machine =~ ^(cherokee|navajo)$ ]]; then
    TEMPLATECONF=$root/meta-yandex-only/meta-$machine/conf/templates/default
elif [[ $machine == g2 ]]; then
    TEMPLATECONF=$root/meta-yandex-shared/meta-g2/conf/templates/default
fi

docker run -it \
           --name=$name \
           --rm `
           \
           # arc внутри контейнера, не разделяющего сеть с хостом,
           # сыпет ошибками "Error occured while calling helper-daemon"
           # при включённой телеметрии` \
           -e ARC_DISABLE_TELEMETRY=1 \
           -v "$(which arc):/usr/bin/arc" \
           -v "$arcadia:$arcadia" `
           # Папка $root/.arc является символической ссылкой на $HOME/.arc` \
           -v "$HOME/.arc:$HOME/.arc" \
           \
           -e BB_ENV_PASSTHROUGH_ADDITIONS=YAV_TOKEN \
           -e YAV_TOKEN=$YAV_TOKEN \
           -v "$(which yav):/usr/bin/yav" `
           \
           # Переменные OEROOT, BUILDDIR и TEMPLATECONF нужны для правильного
           # выполнения bmc-env-exec:
           #   - oe-init-build-env unset'ит OEROOT в конце выполнения,
           #     поэтому никакого эффекта на контейнер переменная не окажет \
           #   - BUILDDIR и TEMPLATECONF инициализируются самим oe-init-build-env` \
           -e OEROOT="$root" \
           -e BUILDDIR="$build" \
           -e TEMPLATECONF="$TEMPLATECONF" \
           -v "$build:$build" \
           crops/poky:ubuntu-22.04 \
           --workdir="$root" \
           sh -c '. ./oe-init-build-env '$(quote "$build")/$machine'
                  HOME=$(pwd) bash'
