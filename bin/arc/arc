#!/usr/bin/env bash

#
# Примеси
#

arc---() {
    "$ARC" "$@"
}

arc-cane() {
    arc ci -a --amend --no-edit
}

arc-diff() {
    # Патч, созданный `arc diff`'ом без флага `--git` воспринимается `git apply`'ем как неправильный
    # Также delta некорректно разбирает такой патч: каждый файл отображается перемещённым
    arc -- diff --git "$@"
}

arc-show() {
    # См. комментарий к `arc-diff`'у
    arc -- show --git "$@"
}

arc-delta() {
    arc diff "$@" | delta -s --wrap-max-lines=unlimited
}

arc-tip() {
    arc show "$@" | delta -s --wrap-max-lines=unlimited
}

arc-apply() {
    git -C "$(arc root)" apply --no-index "$@"
}

arc-drop() {
    local commit=${1:-HEAD}

    ARC_SEQUENCE_EDITOR='sed -i "1 s/pick/drop/"' \
    arc rebase -i $commit~1
}

arc-edit() {
    local commit=${1:-HEAD}

    ARC_SEQUENCE_EDITOR='sed -i "1 s/pick/edit/"' \
    arc rebase -i $commit~1
}

arc-reword() {
    local commit=${1:-HEAD}

    ARC_SEQUENCE_EDITOR='sed -i "1 s/pick/reword/"' \
    arc rebase -i $commit~1
}

#
# Точка входа
#

arc() {
    if declare -F arc-$1 > /dev/null; then
        arc-"$@"
        return
    fi

    arc -- "$@"
}

export ARC=$(which -a arc | grep -v "$(realpath "$0")" | head -1)
if [[ -z "$ARC" ]]; then
    echo "arc: command not found"
    echo "Consider visiting documentation page at 'https://docs.yandex-team.ru/devtools/intro/quick-start-guide' for more details"
    exit 1
fi

arc "$@"
